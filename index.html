<!DOCTYPE html>
<html>
<head>
  <title>Mindfulness App (Enhanced)</title>
  <style>
    /* CSS (Mostly unchanged, added styles for new elements) */
    body {
      font-family: sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
      line-height: 1.6;
    }

    h1, h2 {
        text-align: center;
        color: #5a5a5a;
    }

    #phase1, #phase2, #phase3, #results {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }

    input[type="text"], input[type="number"] {
      padding: 8px;
      margin-right: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 8px 15px;
      background-color: #5c67f2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
      margin-top: 5px; /* Add some top margin for spacing */
    }

    button:hover {
      background-color: #4a54cc;
    }

     button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }


    #thoughtList, #thoughtListPhase3 {
      list-style: none;
      padding: 0;
      margin-top: 10px;
    }

    #thoughtList li, #thoughtListPhase3 li {
      margin-bottom: 8px;
      padding: 10px;
      background-color: #e9e9e9;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

     #thoughtList li span.count, #thoughtListPhase3 li span.count {
        font-weight: bold;
        background-color: #5c67f2;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 10px;
     }


    #thoughtList li:hover, #thoughtListPhase3 li:hover {
        background-color: #dcdcdc;
    }

    #timer, #timerPhase3, #breathworkTimer { /* Style all timers similarly */
      font-size: 1.5em;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
      color: #5c67f2;
    }

    #comparison {
        margin-top: 15px;
        padding: 10px;
        background-color: #e9f5ff;
        border: 1px solid #b3d7ff;
        border-radius: 5px;
    }
    #comparison table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    #comparison th, #comparison td {
        border: 1px solid #b3d7ff;
        padding: 8px;
        text-align: left;
    }
     #comparison th {
        background-color: #d1e7ff;
    }
    /* Style for result change */
    .decrease { color: green; }
    .increase { color: red; }


    /* Basic flow control styling */
    .hidden {
        display: none;
    }

    /* Phase 2 Specific Styles */
     #breathworkGuide {
        margin-top: 15px;
        font-size: 1.4em; /* Make guide text larger */
        font-weight: bold;
        text-align: center;
        padding: 10px;
        background-color: #e9f5ff;
        border-radius: 5px;
        min-height: 30px; /* Ensure space even when empty */
     }
     #breathworkStatus {
        margin-top: 10px;
        text-align: center;
        font-size: 1.1em;
        color: #333;
     }
     #proceedToPhase3Button { /* Make skip button distinct */
        background-color: #ffc107; /* Yellow */
        color: #333;
        display: block; /* Make it take full width */
        width: 80%;
        margin: 15px auto 0 auto; /* Center it */
     }
      #proceedToPhase3Button:hover {
        background-color: #e0a800;
     }


  </style>
</head>
<body>

  <h1>Mindfulness App</h1>

  <div id="phase1">
    <h2>Phase 1: Meditation (Observe Thoughts)</h2>
    <p>Sit comfortably, focus on your breath. When a thought arises, note it below (max 3 words) and click 'Add'. If the thought repeats, click on its entry in the list below to count it.</p>
    <div>
      <label for="meditationDuration">Duration (minutes): </label>
      <input type="number" id="meditationDuration" value="2" min="1" max="60"> </div>
    <div id="timer">00:00</div>
    <button id="startTimer">Start Phase 1</button>
    <button id="stopTimer" class="hidden">End Phase 1 & Proceed</button>
    <hr>
    <input type="text" id="thoughtInput" placeholder="Enter thought (3 words max)" disabled>
    <button id="addThought" disabled>Add Thought</button>
    <ul id="thoughtList"></ul>
  </div>

  <div id="phase2" class="hidden">
    <h2>Phase 2: Guided Breathwork</h2>
    <div id="breathworkOptions">
      <p>Choose a guided breathwork exercise below. You can stop at any time.</p>
      <button class="breathworkBtn" data-type="box">Start Box Breathing</button>
      <button class="breathworkBtn" data-type="478">Start 4-7-8 Breathing</button>
      <button id="skipBreathworkDirectly">Skip Breathwork Entirely</button>
    </div>
    <div id="breathworkActive" class="hidden"> <div id="breathworkGuide">Ready...</div>
        <div id="breathworkStatus">
            <span>Elapsed Time: <span id="breathworkTimer">00:00</span></span> |
            <span>Rounds Completed: <span id="roundCounter">0</span></span>
        </div>
        <button id="proceedToPhase3Button">Stop Breathwork & Proceed to Phase 3</button>
    </div>
  </div>

  <div id="phase3" class="hidden">
    <h2>Phase 3: Meditation (Observe Thoughts Again)</h2>
    <p>Return your focus to your breath. Note any thoughts that arise, just like in Phase 1. This phase will last the same duration as Phase 1.</p>
    <div id="timerPhase3">00:00</div>
    <button id="startTimerPhase3">Start Phase 3</button>
    <button id="stopTimerPhase3" class="hidden">End Phase 3 & See Results</button>
    <hr>
    <input type="text" id="thoughtInputPhase3" placeholder="Enter thought (3 words max)" disabled>
    <button id="addThoughtPhase3" disabled>Add Thought</button>
    <ul id="thoughtListPhase3"></ul>
  </div>

  <div id="results" class="hidden">
    <h2>Results Comparison</h2>
    <p>Here's a comparison of the thoughts noted before and after the breathwork:</p>
    <div id="comparison"></div>
    <button id="startOver">Start Over</button>
  </div>

  <script>
    // --- Phase 1 Variables ---
    const phase1Div = document.getElementById('phase1');
    const durationInput = document.getElementById('meditationDuration');
    const timerDisplay = document.getElementById('timer');
    const startTimerButton = document.getElementById('startTimer');
    const stopTimerButton = document.getElementById('stopTimer');
    const thoughtInput = document.getElementById('thoughtInput');
    const addThoughtButton = document.getElementById('addThought');
    const thoughtList = document.getElementById('thoughtList');
    let thoughtsPhase1 = {};
    let timerInterval;
    let secondsRemaining;
    let phase1Duration = 0;

    // --- Phase 2 Variables ---
    const phase2Div = document.getElementById('phase2');
    const breathworkOptionsDiv = document.getElementById('breathworkOptions');
    const breathworkActiveDiv = document.getElementById('breathworkActive'); // NEW container
    const breathworkGuideDiv = document.getElementById('breathworkGuide');
    const breathworkTimerDisplay = document.getElementById('breathworkTimer'); // NEW span
    const roundCounterDisplay = document.getElementById('roundCounter'); // NEW span
    const skipBreathworkDirectlyButton = document.getElementById('skipBreathworkDirectly'); // NEW button
    const proceedToPhase3Button = document.getElementById('proceedToPhase3Button'); // Renamed button

    let breathInterval; // For guidance steps
    let breathworkElapsedInterval; // For overall timer
    let breathworkRoundCount = 0; // NEW counter
    let breathworkElapsedTime = 0; // NEW timer

    // --- Phase 3 Variables ---
    const phase3Div = document.getElementById('phase3');
    const timerDisplayPhase3 = document.getElementById('timerPhase3');
    const startTimerPhase3Button = document.getElementById('startTimerPhase3');
    const stopTimerPhase3Button = document.getElementById('stopTimerPhase3');
    const thoughtInputPhase3 = document.getElementById('thoughtInputPhase3');
    const addThoughtButtonPhase3 = document.getElementById('addThoughtPhase3');
    const thoughtListPhase3 = document.getElementById('thoughtListPhase3');
    let thoughtsPhase3 = {};
    let timerIntervalPhase3;
    let secondsRemainingPhase3;

    // --- Results Variables ---
    const resultsDiv = document.getElementById('results');
    const comparisonDiv = document.getElementById('comparison');
    const startOverButton = document.getElementById('startOver');

    // --- Utility Functions ---
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    function updateThoughtList(listElement, thoughtsObject) {
        listElement.innerHTML = '';
        const sortedThoughts = Object.entries(thoughtsObject).sort(([,a],[,b]) => b-a); // Sort by count desc

        for (const [thought, count] of sortedThoughts) {
            const listItem = document.createElement('li');
            listItem.textContent = thought;

            const countSpan = document.createElement('span');
            countSpan.className = 'count';
            countSpan.textContent = count;
            listItem.appendChild(countSpan);

            // Re-add event listener for incrementing
             listItem.addEventListener('click', () => {
                thoughtsObject[thought]++;
                updateThoughtList(listElement, thoughtsObject); // Redraw the list
             }, { once: false }); // Ensure listener can fire multiple times

            listElement.appendChild(listItem);
        }
    }


    function addThoughtToList(thought, thoughtsObject, listElement) {
        const cleanedThought = thought.trim().toLowerCase();
        if (cleanedThought.split(' ').length <= 3 && cleanedThought !== '') {
            if (!thoughtsObject[cleanedThought]) {
                thoughtsObject[cleanedThought] = 1;
            } else {
                 // If adding via input field again, maybe don't increment?
                 // Let's assume adding via input always means "first time" or reset intention
                 // thoughtsObject[cleanedThought]++; // Incrementing handled by clicking the list item now
                 thoughtsObject[cleanedThought] = thoughtsObject[cleanedThought] || 1; // Set to 1 if new
            }
            updateThoughtList(listElement, thoughtsObject);
            return true;
        }
         if (cleanedThought !== '') { // Only alert if non-empty but invalid
            alert("Thought must be 3 words or less.");
         }
        return false;
    }

    // --- Phase 1 Logic ---
    startTimerButton.addEventListener('click', () => {
        phase1Duration = parseInt(durationInput.value) * 60;
        if (isNaN(phase1Duration) || phase1Duration <= 0) {
            alert("Please enter a valid duration (1-60 minutes).");
            return;
        }
        secondsRemaining = phase1Duration;
        timerDisplay.textContent = formatTime(secondsRemaining);

        startTimerButton.classList.add('hidden');
        stopTimerButton.classList.remove('hidden');
        durationInput.disabled = true;
        thoughtInput.disabled = false;
        addThoughtButton.disabled = false;

        timerInterval = setInterval(() => {
            secondsRemaining--;
            timerDisplay.textContent = formatTime(secondsRemaining);
            if (secondsRemaining <= 0) {
                stopPhase1();
            }
        }, 1000);
    });

    addThoughtButton.addEventListener('click', () => {
        if (addThoughtToList(thoughtInput.value, thoughtsPhase1, thoughtList)) {
           thoughtInput.value = '';
        }
    });

    thoughtInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
             if (addThoughtToList(thoughtInput.value, thoughtsPhase1, thoughtList)) {
                thoughtInput.value = '';
            }
        }
    });

    stopTimerButton.addEventListener('click', stopPhase1);

    function stopPhase1() {
        clearInterval(timerInterval);
        timerDisplay.textContent = "Finished";
        thoughtInput.disabled = true;
        addThoughtButton.disabled = true;
        stopTimerButton.classList.add('hidden');

        // Transition to Phase 2
        phase1Div.classList.add('hidden');
        phase2Div.classList.remove('hidden');
        breathworkOptionsDiv.classList.remove('hidden'); // Show options
        breathworkActiveDiv.classList.add('hidden'); // Hide active area initially
    }

    // --- Phase 2 Logic ---
    breathworkOptionsDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('breathworkBtn')) {
            const type = e.target.dataset.type;
            startBreathwork(type);
        } else if (e.target.id === 'skipBreathworkDirectly') {
            proceedToPhase3(); // Skip directly without starting guidance
        }
    });

    // Listener for the main "Stop/Proceed" button (available once breathwork starts)
    proceedToPhase3Button.addEventListener('click', () => {
        stopBreathwork(); // Clean up timers
        proceedToPhase3(); // Transition
    });


    function startBreathwork(type) {
        breathworkOptionsDiv.classList.add('hidden'); // Hide initial choices
        breathworkActiveDiv.classList.remove('hidden'); // Show timer, counter, guide area

        // Reset counters and timers
        clearInterval(breathInterval);
        clearTimeout(breathInterval); // Use clear timeout if using recursive setTimeout
        clearInterval(breathworkElapsedInterval);
        breathworkRoundCount = 0;
        breathworkElapsedTime = 0;
        roundCounterDisplay.textContent = breathworkRoundCount;
        breathworkTimerDisplay.textContent = formatTime(breathworkElapsedTime);

        // Start elapsed timer
        breathworkElapsedInterval = setInterval(() => {
             breathworkElapsedTime++;
             breathworkTimerDisplay.textContent = formatTime(breathworkElapsedTime);
        }, 1000);


        // Guidance logic
        let step = 0;
        let instructions = [];
        let durations = []; // in milliseconds

        if (type === 'box') {
            instructions = ['Inhale (4s)...', 'Hold (4s)...', 'Exhale (4s)...', 'Hold (4s)...'];
            durations = [4000, 4000, 4000, 4000];
        } else if (type === '478') {
            instructions = ['Inhale (4s)...', 'Hold (7s)...', 'Exhale (8s)...'];
            // Add a small pause before repeating for clarity
            durations = [4000, 7000, 8000, 1000]; // Added 1s pause
            instructions.push("Pause (1s)...");
        }

        const totalCycleSteps = instructions.length;

        function updateGuidance() {
            const currentStepIndex = step % totalCycleSteps;
            breathworkGuideDiv.textContent = instructions[currentStepIndex];

            // Increment round count AFTER the last step of a cycle completes
            if (currentStepIndex === totalCycleSteps - 1) {
                breathworkRoundCount++;
                roundCounterDisplay.textContent = breathworkRoundCount;
            }

            breathInterval = setTimeout(updateGuidance, durations[currentStepIndex]);
            step++;
        }

        updateGuidance(); // Start the cycle
    }

    function stopBreathwork() {
         clearTimeout(breathInterval); // Stop guidance timer
         clearInterval(breathworkElapsedInterval); // Stop elapsed timer
         breathworkGuideDiv.textContent = 'Stopped'; // Optional: indicate stopped state
    }

    function proceedToPhase3() {
        stopBreathwork(); // Ensure everything is stopped before proceeding
        phase2Div.classList.add('hidden');
        phase3Div.classList.remove('hidden');
        // Set timer for phase 3 to match phase 1
        secondsRemainingPhase3 = phase1Duration;
         if (secondsRemainingPhase3 <= 0) { // Fallback if P1 duration wasn't set
             console.warn("Phase 1 duration not set, defaulting Phase 3 to 2 minutes.");
             secondsRemainingPhase3 = 120;
         }
        timerDisplayPhase3.textContent = formatTime(secondsRemainingPhase3);
        // Ensure phase 3 starts clean
        startTimerPhase3Button.classList.remove('hidden');
        stopTimerPhase3Button.classList.add('hidden');
        thoughtInputPhase3.disabled = true;
        addThoughtButtonPhase3.disabled = true;
        thoughtListPhase3.innerHTML = ''; // Clear phase 3 list if starting over mid-way
        thoughtsPhase3 = {}; // Clear phase 3 thoughts object

    }


    // --- Phase 3 Logic ---
     startTimerPhase3Button.addEventListener('click', () => {
        if (secondsRemainingPhase3 <= 0) {
             alert("Phase 3 duration issue. Please start over.");
             return;
        }
        startTimerPhase3Button.classList.add('hidden');
        stopTimerPhase3Button.classList.remove('hidden');
        thoughtInputPhase3.disabled = false;
        addThoughtButtonPhase3.disabled = false;

        timerIntervalPhase3 = setInterval(() => {
            secondsRemainingPhase3--;
            timerDisplayPhase3.textContent = formatTime(secondsRemainingPhase3);
            if (secondsRemainingPhase3 <= 0) {
                stopPhase3();
            }
        }, 1000);
    });

    addThoughtButtonPhase3.addEventListener('click', () => {
        if (addThoughtToList(thoughtInputPhase3.value, thoughtsPhase3, thoughtListPhase3)) {
            thoughtInputPhase3.value = '';
        }
    });

     thoughtInputPhase3.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
             if (addThoughtToList(thoughtInputPhase3.value, thoughtsPhase3, thoughtListPhase3)) {
                 thoughtInputPhase3.value = '';
            }
        }
    });

    stopTimerPhase3Button.addEventListener('click', stopPhase3);

    function stopPhase3() {
        clearInterval(timerIntervalPhase3);
        timerDisplayPhase3.textContent = "Finished";
        thoughtInputPhase3.disabled = true;
        addThoughtButtonPhase3.disabled = true;
        stopTimerPhase3Button.classList.add('hidden');

        // Transition to Results
        phase3Div.classList.add('hidden');
        resultsDiv.classList.remove('hidden');
        displayResults();
    }

    // --- Results Logic ---
    function displayResults() {
        comparisonDiv.innerHTML = '';
        const allThoughts = new Set([...Object.keys(thoughtsPhase1), ...Object.keys(thoughtsPhase3)]);

        if (allThoughts.size === 0) {
            comparisonDiv.innerHTML = "<p>No thoughts were logged in either phase.</p>";
            return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Thought</th>
                    <th>Phase 1 Count</th>
                    <th>Phase 3 Count</th>
                    <th>Change</th>
                </tr>
            </thead>
            <tbody></tbody>`;
        const tbody = table.querySelector('tbody');

        // Convert Set to Array and sort alphabetically for consistent order
        const sortedAllThoughts = Array.from(allThoughts).sort();

        sortedAllThoughts.forEach(thought => {
            const count1 = thoughtsPhase1[thought] || 0;
            const count3 = thoughtsPhase3[thought] || 0;
            const change = count3 - count1;
            let changeText = change === 0 ? '-' : (change > 0 ? `+${change}` : `${change}`);
            let changeClass = change === 0 ? '' : (change > 0 ? 'increase' : 'decrease');

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${thought}</td>
                <td>${count1}</td>
                <td>${count3}</td>
                <td class="${changeClass}">${changeText}</td>
            `;
            tbody.appendChild(row);
        });

        comparisonDiv.appendChild(table);

        let totalThoughts1 = Object.values(thoughtsPhase1).reduce((sum, count) => sum + count, 0);
        let totalThoughts3 = Object.values(thoughtsPhase3).reduce((sum, count) => sum + count, 0);
        let summaryP = document.createElement('p');
        summaryP.style.marginTop = '15px'; // Add some space above summary
        summaryP.innerHTML = `<strong>Total thoughts noted:</strong> Phase 1: ${totalThoughts1}, Phase 3: ${totalThoughts3}.`;
        comparisonDiv.appendChild(summaryP);
    }

     startOverButton.addEventListener('click', () => {
         // Reset variables
         thoughtsPhase1 = {};
         thoughtsPhase3 = {};
         clearInterval(timerInterval);
         clearInterval(timerIntervalPhase3);
         stopBreathwork(); // Ensure breathwork guide stops and timers cleared

         // Reset UI elements
         thoughtList.innerHTML = '';
         thoughtListPhase3.innerHTML = '';
         comparisonDiv.innerHTML = '';
         timerDisplay.textContent = "00:00";
         timerDisplayPhase3.textContent = "00:00";
         breathworkTimerDisplay.textContent = "00:00"; // Reset breathwork timer display
         roundCounterDisplay.textContent = "0"; // Reset round counter display
         durationInput.disabled = false;
         durationInput.value = "2"; // Reset duration to default
         thoughtInput.value = '';
         thoughtInputPhase3.value = '';

         // Reset visibility and button states
         phase1Div.classList.remove('hidden');
         phase2Div.classList.add('hidden');
         phase3Div.classList.add('hidden');
         resultsDiv.classList.add('hidden');
         breathworkOptionsDiv.classList.remove('hidden'); // Show breathwork options
         breathworkActiveDiv.classList.add('hidden'); // Hide active breathwork area

         startTimerButton.classList.remove('hidden');
         stopTimerButton.classList.add('hidden');
         startTimerPhase3Button.classList.remove('hidden');
         stopTimerPhase3Button.classList.add('hidden');

         thoughtInput.disabled = true;
         addThoughtButton.disabled = true;
         thoughtInputPhase3.disabled = true;
         addThoughtButtonPhase3.disabled = true;
     });

  </script>

</body>
</html>
